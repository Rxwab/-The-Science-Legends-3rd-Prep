<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>علوم للصف الثالث الإعدادي</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts for Arabic (Cairo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General styling and font for the body */
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(to right, #6EE7B7, #3B82F6);
            color: #1F2937;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            direction: rtl; /* Ensure RTL direction for all text */
            text-align: right; /* Align text to the right */
        }

        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #6B7280;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background-color: #F3F4F6;
        }

        /* Card and modal base styling */
        .card, .modal-content {
            background: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 6px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            padding: 2rem;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15), 0 8px 8px rgba(0, 0, 0, 0.15);
        }

        /* Input field styling */
        .input-field {
            border: 2px solid #D1D5DB;
            border-radius: 0.75rem;
            padding: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            border-color: #3B82F6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Button styling */
        .btn-primary {
            background: linear-gradient(to right, #6EE7B7, #3B82F6);
            color: #ffffff;
            border-radius: 9999px;
            padding: 0.75rem 2rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            max-width: 90%;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #4B5563;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: #EF4444;
        }

        /* Room card specific styling */
        .room-card {
            cursor: pointer;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .room-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Special teacher banner styling */
        .teacher-banner {
            background-color: #FBBF24;
            color: #9A3412;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Teacher-only elements */
        .teacher-only {
            display: none;
        }

        /* Loading indicator for Gemini API */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen">

    <!-- The main application container -->
    <div id="app-container" class="relative w-full max-w-4xl min-h-[90vh] bg-white rounded-3xl shadow-2xl p-6 md:p-10 transition-all duration-500 transform">

        <!-- Login Page (initial view) -->
        <div id="login-page" class="absolute inset-0 flex flex-col items-center justify-center p-6 bg-white rounded-3xl z-10 opacity-100 transition-opacity duration-500">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">مرحباً بك في درس العلوم</h1>
            <div class="card w-full max-w-sm flex flex-col items-center p-6 space-y-4">
                <img id="profile-preview" class="w-24 h-24 rounded-full border-4 border-gray-200 object-cover mb-4" src="https://placehold.co/100x100/A0AEC0/ffffff?text=صورة" alt="صورة شخصية">
                <input id="full-name" type="text" placeholder="الاسم الكامل (يجب أن يكون من كلمتين)" class="input-field w-full" required>
                <input id="age" type="number" placeholder="العمر" class="input-field w-full" required>
                <input id="password" type="password" placeholder="كلمة المرور" class="input-field w-full" required>
                <label class="w-full text-sm text-gray-600 cursor-pointer text-center">
                    <input id="profile-pic-input" type="file" accept="image/*" class="hidden">
                    اختر صورة شخصية (اختياري)
                </label>
                <input id="teacher-password" type="password" placeholder="كلمة مرور الأستاذ (اختياري)" class="input-field w-full">
                <button id="login-btn" class="btn-primary w-full text-lg">تسجيل الدخول</button>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div id="main-app" class="absolute inset-0 hidden h-full flex flex-col transition-opacity duration-500">
            
            <!-- Header for user info -->
            <header class="flex flex-col sm:flex-row items-center justify-between p-4 mb-6 rounded-2xl bg-gradient-to-l from-indigo-500 to-blue-500 text-white shadow-xl">
                <div class="flex items-center gap-4">
                    <img id="user-profile-pic" class="w-16 h-16 rounded-full border-4 border-white object-cover shadow-lg" src="https://placehold.co/100x100/ffffff/3B82F6?text=صورة" alt="صورة المستخدم">
                    <div>
                        <h2 id="user-name" class="text-xl font-bold">اسم المستخدم</h2>
                        <p id="user-points" class="text-sm">النقاط: 0</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-4 sm:mt-0">
                    <div id="teacher-status" class="hidden teacher-banner">
                        <i class="fas fa-user-tie"></i>
                        <span>أستاذ</span>
                    </div>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200">
                        تسجيل خروج
                    </button>
                </div>
            </header>

            <!-- Main grid for rooms -->
            <div id="rooms-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow">
                <!-- Room Cards -->
                <div class="room-card card bg-gradient-to-br from-green-400 to-blue-500 text-white" data-room="questions">
                    <i class="room-card-icon fas fa-question-circle"></i>
                    <h3 class="text-xl font-bold">روم الأسئلة</h3>
                </div>
                <!-- These rooms are for teachers only -->
                <div class="room-card card bg-gradient-to-br from-purple-400 to-pink-500 text-white teacher-only" data-room="news">
                    <i class="room-card-icon fas fa-newspaper"></i>
                    <h3 class="text-xl font-bold">روم الأخبار</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-yellow-400 to-orange-500 text-white teacher-only" data-room="homework">
                    <i class="room-card-icon fas fa-book-open"></i>
                    <h3 class="text-xl font-bold">روم الواجبات</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-cyan-400 to-teal-500 text-white teacher-only" data-room="explanations">
                    <i class="room-card-icon fas fa-chalkboard-teacher"></i>
                    <h3 class="text-xl font-bold">روم الشروحات</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-red-400 to-rose-500 text-white" data-room="chat">
                    <i class="room-card-icon fas fa-comments"></i>
                    <h3 class="text-xl font-bold">روم الشات</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-blue-400 to-indigo-500 text-white" data-room="profile">
                    <i class="room-card-icon fas fa-user"></i>
                    <h3 class="text-xl font-bold">ملفي الشخصي</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-emerald-400 to-lime-500 text-white" data-room="store">
                    <i class="room-card-icon fas fa-store"></i>
                    <h3 class="text-xl font-bold">المتجر</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-fuchsia-400 to-purple-500 text-white" data-room="leaderboard">
                    <i class="room-card-icon fas fa-trophy"></i>
                    <h3 class="text-xl font-bold">لوحة الأوائل</h3>
                </div>
                <div class="room-card card bg-gradient-to-br from-gray-400 to-blue-500 text-white teacher-only" data-room="schedule">
                    <i class="room-card-icon fas fa-calendar-alt"></i>
                    <h3 class="text-xl font-bold">روم مواعيد الدروس</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Initially hidden) -->
    
    <!-- Custom message/confirmation modal -->
    <div id="message-modal" class="modal hidden">
        <div class="modal-content text-center p-6">
            <button class="close-btn" onclick="hideModal('message-modal')"><i class="fas fa-times"></i></button>
            <h3 id="message-title" class="text-2xl font-bold mb-4"></h3>
            <p id="message-text" class="text-lg mb-4"></p>
            <div id="modal-actions" class="flex justify-center gap-4">
                <button onclick="hideModal('message-modal')" class="btn-primary">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Questions Room Modal -->
    <div id="questions-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl text-center">
            <button class="close-btn" onclick="hideModal('questions-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم الأسئلة</h2>
            <div id="question-content">
                <p id="question-text" class="text-xl font-medium mb-6"></p>
                <div id="answers-container" class="flex flex-col space-y-4"></div>
            </div>
            <div id="question-feedback" class="mt-6 hidden">
                <p id="feedback-text" class="text-lg font-semibold"></p>
                <p id="explanation-text" class="mt-2 text-gray-700"></p>
                <!-- Add Gemini explanation button -->
                <button id="gemini-explanation-btn" class="btn-primary mt-4">✨ شرح إضافي من Gemini</button>
                <button id="next-question-btn" class="btn-primary mt-4">السؤال التالي</button>
            </div>
        </div>
    </div>

    <!-- News Room Modal -->
    <div id="news-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('news-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم الأخبار</h2>
            <div id="news-list" class="space-y-6"></div>
            <div id="add-news-section" class="mt-8 teacher-only">
                <h3 class="text-2xl font-bold mb-4">إضافة خبر جديد</h3>
                <form id="add-news-form" class="space-y-4">
                    <input id="news-title-input" type="text" placeholder="عنوان الخبر" class="input-field w-full" required>
                    <textarea id="news-content-input" placeholder="محتوى الخبر" rows="4" class="input-field w-full" required></textarea>
                    <input id="news-media-input" type="file" class="input-field w-full">
                    <button type="submit" class="btn-primary w-full">نشر الخبر</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Homework Room Modal -->
    <div id="homework-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('homework-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم الواجبات</h2>
            <div id="homework-list" class="space-y-6"></div>
            <div id="add-homework-section" class="mt-8 teacher-only">
                <h3 class="text-2xl font-bold mb-4">إضافة واجب جديد</h3>
                <form id="add-homework-form" class="space-y-4">
                    <input id="homework-title-input" type="text" placeholder="عنوان الواجب" class="input-field w-full" required>
                    <textarea id="homework-description-input" placeholder="وصف الواجب" rows="4" class="input-field w-full" required></textarea>
                    <input id="homework-media-input" type="file" class="input-field w-full">
                    <button type="submit" class="btn-primary w-full">إضافة الواجب</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Explanations Room Modal -->
    <div id="explanations-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('explanations-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم الشروحات</h2>
            <div id="explanations-list" class="space-y-6"></div>
            <div id="add-explanation-section" class="mt-8 teacher-only">
                <h3 class="text-2xl font-bold mb-4">إضافة شرح جديد</h3>
                <form id="add-explanation-form" class="space-y-4">
                    <input id="explanation-title-input" type="text" placeholder="عنوان الشرح" class="input-field w-full" required>
                    <input id="explanation-link-input" type="url" placeholder="رابط فيديو يوتيوب" class="input-field w-full" required>
                    <button type="submit" class="btn-primary w-full">إضافة الشرح</button>
                </form>
                <div class="mt-4 flex flex-col space-y-4">
                    <h3 class="text-2xl font-bold">استخدام Gemini لإنشاء الشرح</h3>
                    <input id="gemini-explanation-input" type="text" placeholder="اكتب موضوع الشرح..." class="input-field w-full">
                    <div class="flex items-center gap-2">
                        <button id="gemini-explanation-create-btn" class="btn-primary w-full">✨ إنشاء شرح بـ Gemini</button>
                        <div id="gemini-loading" class="spinner hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Room Modal -->
    <div id="schedule-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('schedule-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم مواعيد الدروس</h2>
            <div id="schedule-list" class="space-y-6"></div>
            <div id="add-schedule-section" class="mt-8 teacher-only">
                <h3 class="text-2xl font-bold mb-4">إضافة موعد جديد</h3>
                <form id="add-schedule-form" class="space-y-4">
                    <input id="schedule-title-input" type="text" placeholder="عنوان الموعد" class="input-field w-full" required>
                    <textarea id="schedule-description-input" placeholder="تفاصيل الموعد" rows="4" class="input-field w-full" required></textarea>
                    <input id="schedule-media-input" type="file" class="input-field w-full">
                    <button type="submit" class="btn-primary w-full">إضافة الموعد</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Room Modal -->
    <div id="chat-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl flex flex-col h-[70vh]">
            <button class="close-btn" onclick="hideModal('chat-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">روم الشات</h2>
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 bg-gray-100 rounded-lg mb-4 space-y-4"></div>
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="اكتب رسالتك... (اكتب 'gemini' في البداية للتحدث مع المساعد)" class="input-field flex-grow">
                <button id="send-chat-btn" class="btn-primary px-6"><i class="fas fa-paper-plane"></i></button>
                <button id="clear-chat-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-full px-4 teacher-only">مسح الشات</button>
            </div>
        </div>
    </div>

    <!-- Profile Room Modal -->
    <div id="profile-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl text-center">
            <button class="close-btn" onclick="hideModal('profile-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">الملف الشخصي</h2>
            <div id="user-info-display" class="mb-6">
                <img id="profile-pic-display" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-gray-300 object-cover" src="https://placehold.co/100x100/A0AEC0/ffffff?text=صورة" alt="صورة المستخدم">
                <h3 id="profile-name-display" class="text-xl font-bold mb-1"></h3>
                <p id="profile-points-display" class="text-lg text-gray-600">النقاط: 0</p>
            </div>
            <div id="customize-section" class="mt-8 space-y-4">
                <h3 class="text-2xl font-bold">تغيير الاسم وكلمة المرور</h3>
                <form id="update-profile-form" class="space-y-4">
                    <input id="new-name-input" type="text" placeholder="الاسم الجديد" class="input-field w-full">
                    <input id="new-password-input" type="password" placeholder="كلمة المرور الجديدة" class="input-field w-full">
                    <label class="w-full text-sm text-gray-600 cursor-pointer text-center">
                        <input id="new-profile-pic-input" type="file" accept="image/*" class="hidden">
                        تغيير الصورة الشخصية
                    </label>
                    <button type="submit" class="btn-primary w-full">حفظ التغييرات</button>
                </form>
            </div>
            <div id="apply-items-section" class="mt-8 space-y-4">
                <h3 class="text-2xl font-bold">العناصر التي اشتريتها</h3>
                <div id="purchased-items-list" class="grid grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Store Room Modal -->
    <div id="store-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('store-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-gray-800">المتجر</h2>
            <p class="text-center mb-6 text-gray-600">استخدم نقاطك لشراء عناصر فريدة!</p>
            <div id="store-items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <!-- Leaderboard Room Modal -->
    <div id="leaderboard-room" class="modal hidden">
        <div class="modal-content w-full max-w-2xl">
            <button class="close-btn" onclick="hideModal('leaderboard-room')"><i class="fas fa-times"></i></button>
            <h2 class="text-3xl font-bold mb-4 text-center text-gray-800">لوحة الأوائل</h2>
            <div id="leaderboard-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // --- Global functions for modals ---
        function showModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Custom modal for messages and confirmations
        function showCustomModal(title, text, isConfirm = false, onConfirm = null) {
            const modal = document.getElementById('message-modal');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            const actionsDiv = document.getElementById('modal-actions');
            actionsDiv.innerHTML = '';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'إغلاق';
            closeBtn.className = 'btn-primary';
            closeBtn.onclick = () => hideModal('message-modal');
            actionsDiv.appendChild(closeBtn);

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'تأكيد';
                confirmBtn.className = 'btn-primary bg-red-500 hover:bg-red-600';
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    hideModal('message-modal');
                };
                actionsDiv.appendChild(confirmBtn);
            }
            showModal('message-modal');
        }

        // All JavaScript logic for the app
        document.addEventListener('DOMContentLoaded', () => {

            // --- Global Variables and Data Storage Keys ---
            const LS_USER_DATA = 'userData';
            const LS_LEADERBOARD = 'leaderboard';
            const LS_QUESTIONS = 'questions';
            const LS_CHAT_MESSAGES = 'chatMessages';
            const LS_HOMEWORK = 'homework';
            const LS_EXPLANATIONS = 'explanations';
            const LS_NEWS = 'news';
            const LS_SCHEDULE = 'schedule';

            let userData = {};
            let isTeacher = false;
            let currentQuestionIndex = 0;

            // --- Gemini API Configuration (leave apiKey blank) ---
            const API_KEY = "";
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const loginBtn = document.getElementById('login-btn');
            const fullNameInput = document.getElementById('full-name');
            const ageInput = document.getElementById('age');
            const passwordInput = document.getElementById('password');
            const teacherPasswordInput = document.getElementById('teacher-password');
            const profilePicInput = document.getElementById('profile-pic-input');
            const profilePreview = document.getElementById('profile-preview');
            const userNameDisplay = document.getElementById('user-name');
            const userPointsDisplay = document.getElementById('user-points');
            const userProfilePicDisplay = document.getElementById('user-profile-pic');
            const teacherStatusDisplay = document.getElementById('teacher-status');
            const logoutBtn = document.getElementById('logout-btn');
            const roomsGrid = document.getElementById('rooms-grid');

            // --- Utility Functions for Data Persistence ---
            function saveData(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving to localStorage", e);
                }
            }

            function loadData(key, defaultValue = {}) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    console.error("Error loading from localStorage", e);
                    return defaultValue;
                }
            }

            // Function to extract YouTube video ID from a URL
            function getYouTubeVideoId(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }

            // --- Initial Data for Questions and Store ---
            const initialQuestions = [
                {
                    text: "ما هو تعريف الحركة؟",
                    answers: ["تغير موضع الجسم بمرور الزمن", "ثبات موضع الجسم", "قياس المسافة فقط"],
                    correct: "تغير موضع الجسم بمرور الزمن",
                    explanation: "الحركة هي تغير موضع الجسم بالنسبة لنقطة ثابتة (نقطة مرجعية) بمرور الزمن."
                },
                {
                    text: "ما هي وحدة قياس السرعة؟",
                    answers: ["متر/ثانية", "كيلوجرام", "متر", "ثانية"],
                    correct: "متر/ثانية",
                    explanation: "السرعة هي المسافة المقطوعة في وحدة الزمن، ووحدتها الأساسية في النظام الدولي هي متر/ثانية."
                },
                {
                    text: "متى نقول إن الجسم يتحرك بسرعة منتظمة؟",
                    answers: ["يقطع مسافات متساوية في أزمنة متساوية", "تتغير سرعته", "يتحرك بسرعة عالية"],
                    correct: "يقطع مسافات متساوية في أزمنة متساوية",
                    explanation: "السرعة المنتظمة أو الثابتة هي السرعة التي يتحرك بها الجسم عندما يقطع مسافات متساوية في فترات زمنية متساوية."
                },
                 {
                    text: "ما هو القانون الرياضي لحساب السرعة المتوسطة؟",
                    answers: ["المسافة الكلية / الزمن الكلي", "السرعة الابتدائية + السرعة النهائية", "المسافة المقطوعة فقط"],
                    correct: "المسافة الكلية / الزمن الكلي",
                    explanation: "السرعة المتوسطة تُحسب بقسمة المسافة الكلية التي قطعها الجسم على الزمن الكلي الذي استغرقه لقطع هذه المسافة."
                },
                 {
                    text: "إذا كان جسم يتحرك بسرعة 50 كم/ساعة، ما هي سرعته بالنسبة لجسم آخر يتحرك في نفس الاتجاه بنفس السرعة؟",
                    answers: ["0 كم/ساعة", "100 كم/ساعة", "50 كم/ساعة"],
                    correct: "0 كم/ساعة",
                    explanation: "السرعة النسبية هي السرعة المقاسة بالنسبة لمراقب. عندما يتحرك جسمان في نفس الاتجاه وبنفس السرعة، تكون السرعة النسبية صفراً."
                },
            ];

            const storeItems = [
                { id: 'frame-gold', name: 'إطار ذهبي', cost: 50, type: 'frame', image: 'https://placehold.co/100x100/FFD700/ffffff?text=ذهبي' },
                { id: 'frame-blue', name: 'إطار أزرق', cost: 30, type: 'frame', image: 'https://placehold.co/100x100/3B82F6/ffffff?text=أزرق' },
                { id: 'bg-gradient', name: 'خلفية متدرجة', cost: 75, type: 'background', image: 'https://placehold.co/100x100/6EE7B7/3B82F6?text=خلفية' },
                { id: 'bg-stars', name: 'خلفية نجوم', cost: 60, type: 'background', image: 'https://placehold.co/100x100/1F2937/FCD34D?text=نجوم' },
            ];

            // --- User and App State Management ---
            function renderUserStatus() {
                userNameDisplay.textContent = userData.fullName;
                userPointsDisplay.textContent = `النقاط: ${userData.points || 0}`;
                userProfilePicDisplay.src = userData.profilePic || 'https://placehold.co/100x100/A0AEC0/ffffff?text=صورة';
                
                // Toggle teacher-only elements based on login status
                const teacherElements = document.querySelectorAll('.teacher-only');
                teacherElements.forEach(el => {
                    el.style.display = isTeacher ? 'flex' : 'none';
                });
                teacherStatusDisplay.classList.toggle('hidden', !isTeacher);
            }

            function updateLeaderboard() {
                let leaderboard = loadData(LS_LEADERBOARD, []);
                const userEntryIndex = leaderboard.findIndex(entry => entry.id === userData.id);

                if (userEntryIndex > -1) {
                    leaderboard[userEntryIndex].points = userData.points;
                    leaderboard[userEntryIndex].profilePic = userData.profilePic;
                } else {
                    leaderboard.push({
                        id: userData.id,
                        fullName: userData.fullName,
                        points: userData.points,
                        profilePic: userData.profilePic // Save profile picture to leaderboard
                    });
                }
                leaderboard.sort((a, b) => b.points - a.points);
                saveData(LS_LEADERBOARD, leaderboard);
            }

            function saveAndRenderUser() {
                saveData(LS_USER_DATA, userData);
                updateLeaderboard();
                renderUserStatus();
            }

            function switchToMainApp() {
                loginPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                appContainer.classList.add('scale-100', 'opacity-100');
            }

            function switchToLogin() {
                loginPage.classList.remove('hidden');
                mainApp.classList.add('hidden');
                appContainer.classList.remove('scale-100', 'opacity-100');
            }

            // --- Login and Logout ---
            loginBtn.addEventListener('click', async () => {
                const fullName = fullNameInput.value.trim();
                const age = ageInput.value.trim();
                const password = passwordInput.value.trim();
                const teacherPassword = teacherPasswordInput.value.trim();

                if (fullName.split(' ').length < 2) {
                    showCustomModal('خطأ في الإدخال', 'الاسم الكامل يجب أن يحتوي على الأقل كلمتين.');
                    return;
                }
                if (!age || !password) {
                    showCustomModal('خطأ في الإدخال', 'الرجاء ملء حقول العمر وكلمة المرور.');
                    return;
                }
                
                // Correctly check for teacher login
                isTeacher = (teacherPassword === '6450');

                const userId = `${fullName}-${age}`;
                const savedUsers = loadData(LS_USER_DATA, {});
                const existingUser = savedUsers[userId];
                
                let initialPoints = 0;
                let purchasedItems = [];
                let activeFrame = null;
                let activeBackground = null;
                let profilePic = 'https://placehold.co/100x100/A0AEC0/ffffff?text=صورة'; // Default image

                if (existingUser && existingUser.password === password) {
                    userData = existingUser;
                    isTeacher = existingUser.isTeacher;
                    showCustomModal('تم تسجيل الدخول بنجاح', 'مرحباً بعودتك!');
                } else {
                    // Check for profile picture from file input if this is a new user
                    const file = profilePicInput.files[0];
                    if (file) {
                        profilePic = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                    }

                    userData = {
                        id: userId,
                        fullName: fullName,
                        age: age,
                        password: password,
                        points: initialPoints,
                        profilePic: profilePic, // Use the new profile picture
                        isTeacher: isTeacher,
                        purchasedItems: purchasedItems,
                        activeFrame: activeFrame,
                        activeBackground: activeBackground
                    };

                    showCustomModal('تم التسجيل بنجاح', 'مرحباً بك في التطبيق!');
                }
                
                // Save and render user data regardless of whether it's a new or returning user
                saveData(LS_USER_DATA, { ...loadData(LS_USER_DATA, {}), [userId]: userData });
                saveAndRenderUser();
                switchToMainApp();
            });


            logoutBtn.addEventListener('click', () => {
                showCustomModal('تأكيد تسجيل الخروج', 'هل أنت متأكد من تسجيل الخروج؟', true, () => {
                    userData = {};
                    isTeacher = false;
                    localStorage.removeItem(LS_USER_DATA);
                    switchToLogin();
                    showCustomModal('تم تسجيل الخروج', 'لقد تم تسجيل خروجك بنجاح.');
                });
            });
            
            profilePicInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        profilePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // --- Room Functionality ---

            // Questions Room
            const questionsRoom = document.getElementById('questions-room');
            const questionText = document.getElementById('question-text');
            const answersContainer = document.getElementById('answers-container');
            const questionFeedback = document.getElementById('question-feedback');
            const feedbackText = document.getElementById('feedback-text');
            const explanationText = document.getElementById('explanation-text');
            const geminiExplanationBtn = document.getElementById('gemini-explanation-btn');
            const nextQuestionBtn = document.getElementById('next-question-btn');

            function renderQuestion() {
                const questions = loadData(LS_QUESTIONS, initialQuestions);
                if (currentQuestionIndex >= questions.length) {
                    showCustomModal('أحسنت!', `لقد أكملت جميع الأسئلة. نقاطك هي ${userData.points || 0}`);
                    currentQuestionIndex = 0; // Reset for next time
                    hideModal('questions-room');
                    return;
                }

                const question = questions[currentQuestionIndex];
                questionText.textContent = question.text;
                answersContainer.innerHTML = '';
                question.answers.forEach(answer => {
                    const btn = document.createElement('button');
                    btn.textContent = answer;
                    btn.className = 'bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-colors duration-200';
                    btn.addEventListener('click', () => checkAnswer(btn, question));
                    answersContainer.appendChild(btn);
                });
                questionFeedback.classList.add('hidden');
                answersContainer.classList.remove('hidden');
            }

            function checkAnswer(selectedBtn, question) {
                const allButtons = answersContainer.querySelectorAll('button');
                allButtons.forEach(btn => btn.disabled = true);
                
                if (selectedBtn.textContent === question.correct) {
                    userData.points = (userData.points || 0) + 1;
                    feedbackText.textContent = 'إجابة صحيحة! أحسنت.';
                    feedbackText.className = 'text-green-600 text-lg font-bold';
                    selectedBtn.classList.add('bg-green-500', 'text-white');
                } else {
                    feedbackText.textContent = 'إجابة خاطئة. لا تيأس، حاول مرة أخرى.';
                    feedbackText.className = 'text-red-600 text-lg font-bold';
                    selectedBtn.classList.add('bg-red-500', 'text-white');
                    const correctBtn = Array.from(allButtons).find(btn => btn.textContent === question.correct);
                    if (correctBtn) {
                        correctBtn.classList.add('bg-green-500', 'text-white');
                    }
                }
                explanationText.textContent = question.explanation;
                questionFeedback.classList.remove('hidden');
                saveAndRenderUser();
            }
            
            // Gemini API call for questions explanation
            geminiExplanationBtn.addEventListener('click', async () => {
                const question = initialQuestions[currentQuestionIndex].text;
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'spinner';
                geminiExplanationBtn.parentNode.insertBefore(loadingIndicator, geminiExplanationBtn.nextSibling);
                geminiExplanationBtn.disabled = true;

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: `اشرح مفهوم: "${question}" بطريقة بسيطة وموجزة لطلاب المرحلة الإعدادية.` }]
                            }]
                        })
                    });
                    const result = await response.json();
                    const geminiText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (geminiText) {
                        const explanationDiv = document.createElement('div');
                        explanationDiv.className = 'mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-gray-800 rounded-lg';
                        explanationDiv.innerHTML = `<h5 class="font-bold mb-2">شرح إضافي من Gemini:</h5><p>${geminiText}</p>`;
                        questionsRoom.querySelector('.modal-content').appendChild(explanationDiv);
                    } else {
                        throw new Error('No text generated by Gemini.');
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    showCustomModal('خطأ', 'لم أتمكن من الحصول على شرح إضافي حالياً. حاول مرة أخرى.');
                } finally {
                    loadingIndicator.remove();
                    geminiExplanationBtn.disabled = false;
                }
            });

            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex++;
                renderQuestion();
            });

            // Chat Room
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');

            function renderChat() {
                const messages = loadData(LS_CHAT_MESSAGES, []);
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    const isSender = msg.senderId === userData.id;
                    const isGemini = msg.senderName === 'Gemini';
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex gap-2 items-start ${isSender ? 'self-end flex-row-reverse' : 'self-start'}`;

                    const messageContentDiv = document.createElement('div');
                    messageContentDiv.className = `p-3 rounded-xl shadow-sm max-w-[80%] break-words ${isSender ? 'bg-blue-200' : isGemini ? 'bg-green-200' : 'bg-gray-200'}`;

                    messageContentDiv.innerHTML = `
                        <p class="font-bold text-sm text-gray-700 mb-1">${msg.senderName}</p>
                        <p>${msg.text}</p>
                    `;
                    
                    const profilePic = document.createElement('img');
                    profilePic.src = msg.profilePic || 'https://placehold.co/100x100/A0AEC0/ffffff?text=صورة';
                    profilePic.className = 'w-10 h-10 rounded-full object-cover shadow';

                    if (isTeacher && !isGemini) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'text-red-500 hover:text-red-700 mr-2 text-xs transition-colors duration-200';
                        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                        deleteBtn.onclick = () => showCustomModal('تأكيد الحذف', 'هل أنت متأكد من حذف هذه الرسالة؟', true, () => deleteChatMessage(msg.id));
                        messageContentDiv.appendChild(deleteBtn);
                    }

                    messageDiv.appendChild(profilePic);
                    messageDiv.appendChild(messageContentDiv);
                    
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            }

            function deleteChatMessage(id) {
                let messages = loadData(LS_CHAT_MESSAGES, []);
                messages = messages.filter(msg => msg.id !== id);
                saveData(LS_CHAT_MESSAGES, messages);
                renderChat();
            }

            sendChatBtn.addEventListener('click', async () => {
                const text = chatInput.value.trim();
                if (text) {
                    const messages = loadData(LS_CHAT_MESSAGES, []);
                    messages.push({
                        id: Date.now(),
                        senderId: userData.id, // Save sender ID to differentiate messages
                        senderName: userData.fullName,
                        profilePic: userData.profilePic, // Save profile picture to chat message
                        text: text,
                        isTeacher: isTeacher
                    });
                    saveData(LS_CHAT_MESSAGES, messages);
                    chatInput.value = '';
                    renderChat();

                    // Check if the message is for Gemini
                    if (text.toLowerCase().startsWith('gemini')) {
                        const geminiPrompt = text.substring(6).trim(); // Remove "gemini" and spaces
                        try {
                            const response = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [{ text: `أجب على السؤال التالي باللغة العربية: ${geminiPrompt}` }]
                                    }]
                                })
                            });
                            const result = await response.json();
                            const geminiReply = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (geminiReply) {
                                messages.push({
                                    id: Date.now(),
                                    senderId: 'gemini',
                                    senderName: 'Gemini',
                                    profilePic: 'https://placehold.co/100x100/3B82F6/ffffff?text=AI',
                                    text: geminiReply,
                                    isTeacher: false
                                });
                                saveData(LS_CHAT_MESSAGES, messages);
                                renderChat();
                            }
                        } catch (error) {
                            console.error('Error calling Gemini API for chat:', error);
                        }
                    }
                }
            });

            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', () => {
                    if (isTeacher) {
                        showCustomModal('تأكيد الحذف', 'هل أنت متأكد من حذف جميع رسائل الشات؟', true, () => {
                            saveData(LS_CHAT_MESSAGES, []);
                            renderChat();
                        });
                    }
                });
            }


            // Store Room
            const storeItemsGrid = document.getElementById('store-items-grid');
            function renderStore() {
                storeItemsGrid.innerHTML = '';
                storeItems.forEach(item => {
                    const isPurchased = userData.purchasedItems.some(i => i.id === item.id);
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card text-center p-4 space-y-2';
                    itemCard.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="w-24 h-24 mx-auto rounded-full object-cover">
                        <h4 class="font-bold text-lg">${item.name}</h4>
                        <p class="text-gray-600">التكلفة: ${item.cost} نقطة</p>
                        ${isPurchased ? `<button class="btn-primary w-full text-sm opacity-50 cursor-not-allowed" disabled>تم الشراء</button>` : `<button class="buy-btn btn-primary w-full text-sm" data-item-id="${item.id}">شراء</button>`}
                    `;
                    storeItemsGrid.appendChild(itemCard);
                });

                document.querySelectorAll('.buy-btn').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        const itemId = event.target.dataset.itemId;
                        const item = storeItems.find(i => i.id === itemId);
                        if (userData.points >= item.cost) {
                            userData.points -= item.cost;
                            userData.purchasedItems.push(item);
                            saveAndRenderUser();
                            showCustomModal('تم الشراء!', `لقد اشتريت "${item.name}" بنجاح.`);
                            renderProfile();
                            renderStore();
                        } else {
                            showCustomModal('نقاط غير كافية', 'لا تملك نقاطًا كافية لشراء هذا العنصر.');
                        }
                    });
                });
            }

            // Profile Room
            const profilePicDisplay = document.getElementById('profile-pic-display');
            const profileNameDisplay = document.getElementById('profile-name-display');
            const profilePointsDisplay = document.getElementById('profile-points-display');
            const newNameInput = document.getElementById('new-name-input');
            const newPasswordInput = document.getElementById('new-password-input');
            const newProfilePicInput = document.getElementById('new-profile-pic-input');
            const updateProfileForm = document.getElementById('update-profile-form');
            const purchasedItemsList = document.getElementById('purchased-items-list');

            function renderProfile() {
                profilePicDisplay.src = userData.profilePic;
                profileNameDisplay.textContent = userData.fullName;
                profilePointsDisplay.textContent = `النقاط: ${userData.points}`;

                purchasedItemsList.innerHTML = '';
                userData.purchasedItems.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card text-center p-4 space-y-2';
                    itemCard.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="w-24 h-24 mx-auto rounded-full object-cover">
                        <h4 class="font-bold text-lg">${item.name}</h4>
                        <button class="apply-btn btn-primary w-full text-sm" data-item-type="${item.type}" data-item-id="${item.id}">تطبيق</button>
                    `;
                    purchasedItemsList.appendChild(itemCard);
                });

                document.querySelectorAll('.apply-btn').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        const type = event.target.dataset.itemType;
                        const id = event.target.dataset.itemId;
                        if (type === 'frame') {
                            userData.activeFrame = id;
                            profilePicDisplay.style.borderColor = (id === 'frame-gold') ? '#FFD700' : '#3B82F6';
                        } else if (type === 'background') {
                            userData.activeBackground = id;
                            document.body.style.background = (id === 'bg-gradient') ? 'linear-gradient(to right, #6EE7B7, #3B82F6)' : 'linear-gradient(to bottom, #1F2937, #374151)';
                            document.body.style.color = (id === 'bg-stars') ? '#F3F4F6' : '#1F2937';
                        }
                        saveAndRenderUser();
                        showCustomModal('تم التطبيق!', `تم تطبيق العنصر بنجاح.`);
                        hideModal('profile-room');
                    });
                });
                
                // Set active items on load
                if (userData.activeFrame) {
                    profilePicDisplay.style.borderColor = (userData.activeFrame === 'frame-gold') ? '#FFD700' : '#3B82F6';
                }
                if (userData.activeBackground) {
                    document.body.style.background = (userData.activeBackground === 'bg-gradient') ? 'linear-gradient(to right, #6EE7B7, #3B82F6)' : 'linear-gradient(to bottom, #1F2937, #374151)';
                    document.body.style.color = (userData.activeBackground === 'bg-stars') ? '#F3F4F6' : '#1F2937';
                }
            }

            updateProfileForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = newNameInput.value.trim();
                const newPassword = newPasswordInput.value.trim();

                if (newName) userData.fullName = newName;
                if (newPassword) userData.password = newPassword;
                saveAndRenderUser();
                showCustomModal('تم التحديث!', 'تم تحديث ملفك الشخصي بنجاح.');
                renderProfile();
            });

            newProfilePicInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        userData.profilePic = e.target.result;
                        saveAndRenderUser();
                        renderProfile();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Leaderboard Room
            const leaderboardList = document.getElementById('leaderboard-list');
            function renderLeaderboard() {
                const leaderboard = loadData(LS_LEADERBOARD, []);
                leaderboardList.innerHTML = '';
                if (leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-center text-gray-500">لا توجد بيانات حتى الآن.</p>';
                    return;
                }
                leaderboard.slice(0, 100).forEach((user, index) => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-lg shadow-sm';
                    const medalColor = index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-yellow-600' : 'text-gray-500';
                    userDiv.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="text-xl font-bold ${medalColor}">#${index + 1}</span>
                            <img src="${user.profilePic}" alt="صورة ${user.fullName}" class="w-10 h-10 rounded-full object-cover">
                            <span class="text-lg">${user.fullName}</span>
                        </div>
                        <span class="text-md text-gray-700 font-semibold">${user.points} نقاط</span>
                    `;
                    leaderboardList.appendChild(userDiv);
                });
            }

            // News Room Functionality
            const newsList = document.getElementById('news-list');
            const addNewsForm = document.getElementById('add-news-form');
            function renderNews() {
                const news = loadData(LS_NEWS, []);
                newsList.innerHTML = '';
                if (news.length === 0) {
                    newsList.innerHTML = '<p class="text-center text-gray-500">لا توجد أخبار حاليًا.</p>';
                    return;
                }
                news.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card p-4 space-y-2';
                    itemCard.innerHTML = `
                        <h4 class="font-bold text-xl">${item.title}</h4>
                        <p class="text-gray-700">${item.content}</p>
                        ${item.media ? `<img src="${item.media}" alt="Media" class="rounded-lg mt-2 w-full object-cover">` : ''}
                    `;
                    newsList.appendChild(itemCard);
                });
            }
            if (addNewsForm) {
                 addNewsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('news-title-input').value;
                    const content = document.getElementById('news-content-input').value;
                    const mediaFile = document.getElementById('news-media-input').files[0];
                    let news = loadData(LS_NEWS, []);

                    if (mediaFile) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            news.push({ title, content, media: event.target.result });
                            saveData(LS_NEWS, news);
                            renderNews();
                            addNewsForm.reset();
                            showCustomModal('تم النشر!', 'تم نشر الخبر بنجاح.');
                        };
                        reader.readAsDataURL(mediaFile);
                    } else {
                        news.push({ title, content });
                        saveData(LS_NEWS, news);
                        renderNews();
                        addNewsForm.reset();
                        showCustomModal('تم النشر!', 'تم نشر الخبر بنجاح.');
                    }
                });
            }
            
            // Homework Room Functionality
            const homeworkList = document.getElementById('homework-list');
            const addHomeworkForm = document.getElementById('add-homework-form');
            function renderHomework() {
                const homework = loadData(LS_HOMEWORK, []);
                homeworkList.innerHTML = '';
                if (homework.length === 0) {
                    homeworkList.innerHTML = '<p class="text-center text-gray-500">لا توجد واجبات حاليًا.</p>';
                    return;
                }
                homework.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card p-4 space-y-2';
                    itemCard.innerHTML = `
                        <h4 class="font-bold text-xl">${item.title}</h4>
                        <p class="text-gray-700">${item.description}</p>
                        ${item.media ? `<img src="${item.media}" alt="Media" class="rounded-lg mt-2 w-full object-cover">` : ''}
                        ${item.mediaLink ? `<a href="${item.mediaLink}" target="_blank" class="text-blue-500 hover:underline">رابط الواجب</a>` : ''}
                    `;
                    homeworkList.appendChild(itemCard);
                });
            }
            if (addHomeworkForm) {
                addHomeworkForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('homework-title-input').value;
                    const description = document.getElementById('homework-description-input').value;
                    const mediaFile = document.getElementById('homework-media-input').files[0];
                    let homework = loadData(LS_HOMEWORK, []);

                    if (mediaFile) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            homework.push({ title, description, media: event.target.result });
                            saveData(LS_HOMEWORK, homework);
                            renderHomework();
                            addHomeworkForm.reset();
                            showCustomModal('تم الإضافة!', 'تم إضافة الواجب بنجاح.');
                        };
                        reader.readAsDataURL(mediaFile);
                    } else {
                        homework.push({ title, description });
                        saveData(LS_HOMEWORK, homework);
                        renderHomework();
                        addHomeworkForm.reset();
                        showCustomModal('تم الإضافة!', 'تم إضافة الواجب بنجاح.');
                    }
                });
            }

            // Explanations Room Functionality
            const explanationsList = document.getElementById('explanations-list');
            const addExplanationForm = document.getElementById('add-explanation-form');
            const geminiExplanationInput = document.getElementById('gemini-explanation-input');
            const geminiExplanationCreateBtn = document.getElementById('gemini-explanation-create-btn');
            const geminiLoading = document.getElementById('gemini-loading');
            
            function renderExplanations() {
                const explanations = loadData(LS_EXPLANATIONS, []);
                explanationsList.innerHTML = '';
                if (explanations.length === 0) {
                    explanationsList.innerHTML = '<p class="text-center text-gray-500">لا توجد شروحات حاليًا.</p>';
                    return;
                }
                explanations.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card p-4 space-y-2';
                    const videoId = getYouTubeVideoId(item.link);
                    itemCard.innerHTML = `
                        <h4 class="font-bold text-xl">${item.title}</h4>
                        ${item.content ? `<p class="text-gray-700">${item.content}</p>` : ''}
                        ${videoId ? `<iframe class="w-full aspect-video rounded-lg mt-2" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>` : `<p class="text-red-500">رابط الفيديو غير صالح.</p>`}
                    `;
                    explanationsList.appendChild(itemCard);
                });
            }
            if (addExplanationForm) {
                addExplanationForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('explanation-title-input').value;
                    const link = document.getElementById('explanation-link-input').value;
                    let explanations = loadData(LS_EXPLANATIONS, []);

                    if (getYouTubeVideoId(link)) {
                         explanations.push({ title, link });
                         saveData(LS_EXPLANATIONS, explanations);
                         renderExplanations();
                         addExplanationForm.reset();
                         showCustomModal('تم الإضافة!', 'تم إضافة الشرح بنجاح.');
                    } else {
                         showCustomModal('خطأ في الرابط', 'الرجاء إدخال رابط يوتيوب صالح.');
                    }
                });
            }

            // Gemini API call to create explanation content
            if (geminiExplanationCreateBtn) {
                geminiExplanationCreateBtn.addEventListener('click', async () => {
                    const topic = geminiExplanationInput.value.trim();
                    if (!topic) {
                        showCustomModal('خطأ', 'الرجاء إدخال موضوع الشرح.');
                        return;
                    }
                    geminiLoading.classList.remove('hidden');
                    geminiExplanationCreateBtn.disabled = true;

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: `اكتب شرحًا علميًا بسيطًا ومفصلاً باللغة العربية حول موضوع "${topic}" لطلاب المرحلة الإعدادية. استخدم فقرات واضحة ومركزة.` }]
                                }]
                            })
                        });
                        const result = await response.json();
                        const geminiText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (geminiText) {
                            let explanations = loadData(LS_EXPLANATIONS, []);
                            explanations.push({ title: topic, content: geminiText, link: '' });
                            saveData(LS_EXPLANATIONS, explanations);
                            renderExplanations();
                            showCustomModal('تم الإنشاء!', 'تم إنشاء الشرح بواسطة Gemini بنجاح.');
                        } else {
                            throw new Error('No text generated by Gemini.');
                        }
                    } catch (error) {
                        console.error('Error calling Gemini API for explanation:', error);
                        showCustomModal('خطأ', 'لم أتمكن من إنشاء الشرح حاليًا. حاول مرة أخرى.');
                    } finally {
                        geminiLoading.classList.add('hidden');
                        geminiExplanationCreateBtn.disabled = false;
                    }
                });
            }

            // Schedule Room Functionality
            const scheduleList = document.getElementById('schedule-list');
            const addScheduleForm = document.getElementById('add-schedule-form');
            function renderSchedule() {
                const schedule = loadData(LS_SCHEDULE, []);
                scheduleList.innerHTML = '';
                if (schedule.length === 0) {
                    scheduleList.innerHTML = '<p class="text-center text-gray-500">لا توجد مواعيد حاليًا.</p>';
                    return;
                }
                schedule.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'card p-4 space-y-2';
                    itemCard.innerHTML = `
                        <h4 class="font-bold text-xl">${item.title}</h4>
                        <p class="text-gray-700">${item.description}</p>
                        ${item.media ? `<img src="${item.media}" alt="Media" class="rounded-lg mt-2 w-full object-cover">` : ''}
                    `;
                    scheduleList.appendChild(itemCard);
                });
            }
            if (addScheduleForm) {
                addScheduleForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = document.getElementById('schedule-title-input').value;
                    const description = document.getElementById('schedule-description-input').value;
                    const mediaFile = document.getElementById('schedule-media-input').files[0];
                    let schedule = loadData(LS_SCHEDULE, []);

                    if (mediaFile) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            schedule.push({ title, description, media: event.target.result });
                            saveData(LS_SCHEDULE, schedule);
                            renderSchedule();
                            addScheduleForm.reset();
                            showCustomModal('تم الإضافة!', 'تم إضافة الموعد بنجاح.');
                        };
                        reader.readAsDataURL(mediaFile);
                    } else {
                        schedule.push({ title, description });
                        saveData(LS_SCHEDULE, schedule);
                        renderSchedule();
                        addScheduleForm.reset();
                        showCustomModal('تم الإضافة!', 'تم إضافة الموعد بنجاح.');
                    }
                });
            }


            // --- Main Event Listener for Rooms ---
            roomsGrid.addEventListener('click', (event) => {
                const card = event.target.closest('.room-card');
                if (!card) return;

                const room = card.dataset.room;
                switch (room) {
                    case 'questions':
                        showModal('questions-room');
                        renderQuestion();
                        break;
                    case 'news':
                        showModal('news-room');
                        renderNews();
                        break;
                    case 'homework':
                        showModal('homework-room');
                        renderHomework();
                        break;
                    case 'explanations':
                        showModal('explanations-room');
                        renderExplanations();
                        break;
                    case 'schedule':
                        showModal('schedule-room');
                        renderSchedule();
                        break;
                    case 'chat':
                        showModal('chat-room');
                        renderChat();
                        break;
                    case 'profile':
                        showModal('profile-room');
                        renderProfile();
                        break;
                    case 'store':
                        showModal('store-room');
                        renderStore();
                        break;
                    case 'leaderboard':
                        showModal('leaderboard-room');
                        renderLeaderboard();
                        break;
                }
            });

            // --- Initial App Load ---
            function loadApp() {
                const savedUsers = loadData(LS_USER_DATA, {});

                // If user data exists, try to load it
                if (Object.keys(savedUsers).length > 0) {
                    // This is a simple logic to auto-login the last user.
                    // A real app would require a session or re-login.
                    const lastUserKey = Object.keys(savedUsers)[Object.keys(savedUsers).length - 1];
                    userData = savedUsers[lastUserKey];
                    isTeacher = userData.isTeacher;
                    switchToMainApp();
                    renderUserStatus();
                    renderProfile(); // Render profile to apply purchased themes
                } else {
                    switchToLogin();
                }
            }

            loadApp();
        });
    </script>
</body>
</html>
